name: Release to PyPI

on:
  push:
    tags: ["v*"]

permissions:
  id-token: write # OIDC for PyPI Trusted Publishing
  contents: write # allow creating GitHub releases and updating CHANGELOG
jobs:
  build:
    name: Build distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v4
        with:
          python-version: "3.12"

      - name: Build package
        run: uv build

      - name: Upload distribution artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*
  publish:
    name: Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/cryptoservice
    permissions:
      id-token: write # IMPORTANT: this permission is mandatory for trusted publishing

    steps:
      - name: Download distribution artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          verbose: true
  release-notes:
    name: Create GitHub Release
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      contents: write # allow creating GitHub releases
    env:
      TAG_NAME: ${{ github.ref_name }} # e.g. v1.16.3

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v4
        with:
          python-version: "3.12"

      - name: Extract version
        run: |
          VER="${TAG_NAME#v}"
          echo "VER=$VER" >> "$GITHUB_ENV"

      - name: Generate release notes from CHANGELOG
        run: |
          # ä»Ž CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„å†…å®¹
          if [ -f "CHANGELOG.md" ]; then
            # åŒ¹é…ç‰ˆæœ¬æ ‡é¢˜æ ¼å¼: ## v1.16.3 (2025-01-30) æˆ– ## 1.16.3
            awk -v ver="$VER" '
              BEGIN { found=0 }
              /^## / {
                if (found) exit
                if ($0 ~ ver) { found=1; next }
              }
              found { print }
            ' CHANGELOG.md > RELEASE_BODY.md

            # å¦‚æžœæå–å¤±è´¥ï¼Œä½¿ç”¨ towncrier ç”Ÿæˆ
            if [ ! -s RELEASE_BODY.md ]; then
              echo "Using towncrier to generate release notes..."
              uvx towncrier build --draft --version "$VER" > RELEASE_BODY.md
            fi
          else
            # å¦‚æžœæ²¡æœ‰ CHANGELOGï¼Œä½¿ç”¨ towncrier
            echo "No CHANGELOG.md found, using towncrier..."
            uvx towncrier build --draft --version "$VER" > RELEASE_BODY.md
          fi

          echo "Release notes:"
          cat RELEASE_BODY.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          body_path: RELEASE_BODY.md
          draft: false
          files: |
            dist/*

      - name: Notify webhook
        if: secrets.WEBHOOK_URL != ''
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          python - <<'PY'
          import json, os, urllib.request

          content = open("RELEASE_BODY.md", "r", encoding="utf-8").read()
          tag = os.environ.get("TAG_NAME")

          # é£žä¹¦é€šçŸ¥æ ¼å¼
          text = f"ðŸš€ å‘å¸ƒ {tag} åˆ° PyPI\n\n{content}\n\næŸ¥çœ‹: https://pypi.org/project/cryptoservice/"
          body = {"msg_type": "text", "content": {"text": text}}

          webhook_url = os.environ.get("WEBHOOK_URL", "")
          if webhook_url:
              req = urllib.request.Request(
                  webhook_url,
                  data=json.dumps(body).encode(),
                  headers={"Content-Type": "application/json"}
              )
              resp = urllib.request.urlopen(req)
              print(f"Notification sent: {resp.status}")
          else:
              print("No webhook URL configured, skipping notification")
          PY
